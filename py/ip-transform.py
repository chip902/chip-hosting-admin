import ipaddress
from time import sleep
from collections import defaultdict


def expand_cidr(cidr):
    try:
        network = ipaddress.ip_network(cidr, strict=False)
        return [str(ip) for ip in network.hosts()]
    except ValueError as e:
        print(f"Error expanding CIDR {cidr}: {str(e)}")
        return []


def get_network_prefix(ip):
    # Remove CIDR notation if present
    if "/" in ip:
        ip = ip.split("/")[0]
    # Get first three octets
    return ".".join(ip.split(".")[:3])


def analyze_ip_range(ips_in_prefix):
    # Convert last octet to set of integers
    last_octets = {int(ip.split(".")[-1]) for ip in ips_in_prefix}

    # If we have most of a /24 range (more than 250 IPs), treat it as a full range
    if len(last_octets) > 250:
        return "full_range"

    # If we have fewer IPs, return the specific count
    return len(last_octets)


def main():
    print("Starting CIDR expansion...")
    cidr_list = [
        "148.168.40.0/24",
        "170.116.64.0/24",
        "148.168.96.0/24",
        "204.114.196.0/24",
        "204.114.199.0/27",
        "148.168.216.0/24",
        "168.224.160.0/24",
        "148.168.19.194/32",
        "103.197.3.0/24",
        "204.114.176.0/26",
        "204.114.196.0/24",
        "3.251.148.120/29",
        "34.250.63.248/29",
        "34.228.4.208/28",
        "44.192.245.160/28",
        "44.192.255.128/28",
        "34.237.69.19/32",
        "3.90.92.128/32",
        "34.224.103.64/32",
        "3.230.7.211/32",
        "34.239.190.8/32",
        "3.228.30.142/32",
        "54.236.108.39/32",
        "52.72.221.2/32",
        "3.210.3.208/32",
        "35.173.5.69/32",
        "18.234.6.105/32",
        "54.160.228.108/32",
        "130.41.11.192/30",
        "130.41.11.196/32",
        "130.41.11.129/32",
        "130.41.11.131/32",
        "130.41.11.132/31",
        "130.41.11.134/32",
        "130.41.12.192/30",
        "130.41.12.196/32",
        "128.77.95.139/32",
        "128.77.95.140/30",
        "130.41.10.128/32",
        "130.41.10.130/32",
        "130.41.63.14/32",
        "130.41.63.19/32",
        "130.41.63.81/32",
        "165.85.56.254/32",
        "130.41.70.84/30",
        "130.41.70.88/31",
        "130.41.70.91/32",
        "130.41.230.158/31",
        "130.41.230.160/30",
        "134.238.206.78/31",
        "134.238.178.32/29",
        "134.238.178.40/30",
        "134.238.178.44/32",
        "134.238.178.228/32",
        "134.238.178.254/32",
        "130.41.42.139/32",
        "130.41.42.140/31",
        "130.41.42.142/32",
        "130.41.42.144/29",
        "130.41.42.152/31",
        "130.41.42.154/32",
        "130.41.14.16/32",
        "130.41.15.231/32",
        "130.41.15.232/32",
        "165.85.157.54/31",
        "130.41.44.2/32",
        "130.41.44.17/32",
        "130.41.44.18/31",
        "130.41.44.166/31",
        "130.41.44.168/29",
        "130.41.44.176/29",
        "130.41.44.185/32",
        "130.41.44.186/31",
        "130.41.44.188/30",
        "130.41.44.192/29",
        "208.127.72.65/32",
        "208.127.72.66/31",
        "208.127.72.68/31",
        "208.127.72.70/32",
        "208.127.77.59/32",
        "208.127.77.183/32",
        "128.77.42.0/32",
        "130.41.48.2/32",
        "130.41.48.18/31",
        "130.41.48.20/32",
        "130.41.48.175/32",
        "130.41.48.176/28",
        "130.41.48.193/32",
        "130.41.48.194/31",
        "130.41.48.196/30",
        "130.41.48.200/29",
        "130.41.48.208/32",
        "208.127.68.241/32",
        "208.127.69.19/32",
        "208.127.69.35/32",
        "208.127.69.37/32",
        "208.127.69.38/32",
        "208.127.90.204/31",
        "128.77.51.41/32",
        "128.77.51.42/32",
        "130.41.245.160/32",
        "165.85.47.249/32",
        "165.85.47.250/32",
        "130.41.158.246/31",
        "208.127.108.167/32",
        "208.127.108.170/31",
        "130.41.40.23/32",
        "130.41.40.222/31",
        "130.41.40.224/31",
        "130.41.40.227/32",
        "130.41.40.228/30",
        "130.41.40.232/30",
        "130.41.40.236/32",
        "130.41.52.4/32",
        "130.41.52.39/32",
        "130.41.52.40/31",
        "165.1.147.86/31",
        "165.1.147.88/31",
        "208.127.234.41/32",
        "66.159.209.239/32",
        "130.41.2.168/32",
        "130.41.2.170/32",
        "165.85.11.134/32",
        "208.127.112.162/32",
        "128.77.72.100/32",
        "128.77.72.184/32",
        "137.83.237.107/32",
        "137.83.237.108/31",
        "130.41.0.5/32",
        "130.41.0.6/32",
        "130.41.0.44/30",
        "130.41.0.48/30",
        "130.41.0.52/31",
        "130.41.0.59/32",
        "130.41.0.60/30",
        "130.41.0.64/32",
        "130.41.0.66/32",
        "165.1.239.28/31",
        "130.41.1.203/32",
        "130.41.1.204/30",
        "130.41.1.208/30",
        "130.41.1.212/31",
        "130.41.1.215/32",
        "130.41.1.216/30",
        "130.41.1.220/31",
        "130.41.1.222/32",
        "134.238.17.12/32",
        "134.238.238.220/32",
        "114.141.121.104/30",
        "114.141.121.108/31",
        "114.141.121.111/32",
        "114.141.121.112/31",
        "66.159.194.201/32",
        "114.141.120.70/31",
        "114.141.120.72/32",
        "114.141.120.74/31",
        "114.141.120.77/32",
        "114.141.120.78/32",
        "165.85.203.53/32",
        "66.159.197.29/32",
        "66.159.197.53/32",
        "66.159.197.54/32",
        "130.41.88.175/32",
        "130.41.88.176/32",
        "130.41.214.253/32",
        "130.41.214.255/32",
        "134.238.28.57/32",
        "134.238.28.58/32",
        "66.159.196.54/31",
        "130.41.6.136/30",
        "130.41.6.140/31",
        "130.41.6.142/32",
        "13.124.75.159/32",
        "13.124.211.181/32",
        "165.85.65.37/32",
        "165.85.65.38/32",
        "208.127.61.38/32",
        "208.127.61.126/32",
        "208.127.61.155/32",
        "208.127.61.156/30",
        "208.127.61.160/30",
        "208.127.61.164/32",
        "130.41.28.135/32",
        "130.41.28.136/31",
        "130.41.28.139/32",
        "130.41.28.140/30",
        "130.41.28.144/28",
        "130.41.28.160/31",
        "130.41.28.162/32",
        "130.41.20.39/32",
        "130.41.20.101/32",
        "130.41.20.102/31",
        "130.41.20.104/29",
        "130.41.20.112/31",
        "130.41.20.115/32",
        "130.41.20.116/30",
        "130.41.20.120/29",
        "130.41.134.73/32",
        "130.41.134.165/32",
        "130.41.134.216/31",
        "130.41.85.2/32",
        "130.41.85.20/32",
        "130.41.85.22/32",
        "130.41.85.199/32",
        "130.41.85.200/29",
        "130.41.85.208/29",
        "130.41.85.216/30",
        "130.41.85.220/32",
        "134.238.213.187/32",
        "208.127.102.106/32",
        "130.41.17.155/32",
        "130.41.17.156/30",
        "130.41.17.160/29",
        "130.41.17.168/32",
        "130.41.17.170/31",
        "130.41.17.172/30",
        "130.41.17.176/30",
        "130.41.17.180/31",
        "130.41.17.182/32",
        "208.127.27.229/32",
        "208.127.27.230/32",
        "63.35.148.115/32",
        "63.35.148.117/32",
        "108.128.191.211/32",
        "108.128.221.203/32",
        "108.128.230.153/32",
        "108.128.237.54/32",
        "130.41.26.131/32",
        "130.41.26.132/30",
        "130.41.26.136/29",
        "130.41.26.145/32",
        "130.41.26.147/32",
        "130.41.26.148/30",
        "130.41.26.152/29",
        "165.85.25.152/31",
        "165.85.136.70/31",
        "130.41.32.11/32",
        "130.41.32.12/30",
        "130.41.32.104/32",
        "130.41.32.106/31",
        "130.41.32.108/30",
        "130.41.32.112/30",
        "130.41.32.116/32",
        "130.41.32.118/31",
        "130.41.32.120/29",
        "130.41.29.52/30",
        "130.41.29.56/30",
        "130.41.29.60/31",
        "130.41.29.62/32",
        "130.41.29.101/32",
        "130.41.29.112/29",
        "130.41.29.120/30",
        "130.41.29.125/32",
        "130.41.29.126/31",
        "13.244.215.227/32",
        "13.244.217.55/32",
        "13.244.217.107/32",
        "13.244.219.13/32",
        "130.41.9.128/30",
        "130.41.22.128/29",
        "130.41.22.136/30",
        "130.41.22.140/32",
        "130.41.22.143/32",
        "130.41.22.144/31",
        "130.41.22.147/32",
        "130.41.22.148/30",
        "130.41.22.152/30",
        "130.41.22.156/31",
        "134.238.53.89/32",
        "134.238.53.92/31",
        "134.238.54.100/32",
        "134.238.54.105/32",
        "96.9.77.114/32",
        "91.214.30.139/32",
        "86.14.88.62/32",
        "92.232.86.121/32",
        "82.66.214.47/32",
    ]

    total_cidrs = len(cidr_list)
    print(f"Processing {total_cidrs} CIDR blocks...")

    prefix_groups = defaultdict(set)

    # Process each CIDR
    for cidr in cidr_list:
        expanded_ips = expand_cidr(cidr)
        for ip in expanded_ips:
            prefix = get_network_prefix(ip)
            prefix_groups[prefix].add(ip)

    # Write results to file
    with open("consolidated_ips.txt", "w") as f:
        # Convert to sorted list of prefixes
        prefixes = sorted([f"{prefix}." for prefix in prefix_groups.keys()])

        # Write in chunks of 100 prefixes per line
        for i in range(0, len(prefixes), 100):
            chunk = prefixes[i : i + 100]
            f.write(" ".join(chunk) + "\n")

        print(f"Consolidated {len(prefixes)} network prefixes")


if __name__ == "__main__":
    main()
